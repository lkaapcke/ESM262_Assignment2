---
title: "ESM 262 HW 2"
author: "Lauren Kaapcke"
date: "May 17, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import and Tidy

1. Load tidyverse and read gazetteer data into a tibble. 

```{r tools_data, warning = F, message = F}

library(tidyverse)
library(knitr)
library(DBI)
library(dplyr)

#Read in data
gaz_raw <- as_tibble(read_delim("C:/Users/lnkaa/Documents/ESM Computing/CA_Features_20180401.txt", delim = "|", col_names = T, col_types = cols(.default = col_character())))
#summary(gaz_raw)

```

2. Select desired columns.

```{r table, warning = F, message = F}

gaz <- gaz_raw %>% 
  select(FEATURE_ID:STATE_ALPHA, COUNTY_NAME, ends_with("_DEC"), ELEV_IN_M, MAP_NAME:DATE_EDITED)
#View(gaz)

```

3. Convert the columns to the appropriate type. Convert unknown placeholders to NA. 

```{r convert, warning = F, message = F}

#Replace "Unknown" with "NA"
is.na(gaz) <- gaz == "Unknown"

#Convert columns
gaz <- type_convert(gaz, col_types = cols( 
  FEATURE_ID = col_double(),
  PRIM_LAT_DEC = col_double(),
  PRIM_LONG_DEC = col_double(),
  SOURCE_LAT_DEC = col_double(),
  SOURCE_LONG_DEC = col_double(),
  ELEV_IN_M = col_double(),
  DATE_CREATED = col_date(format = "%m/%d/%Y"),
  DATE_EDITED = col_date(format = "%m/%d/%Y")
))
#head(gaz) #Check conversion worked

```

4. Delete rows with NA for primary longitude or latitude or where the feature is not California.

```{r filter, message = F, warning = F}

gaz <- gaz %>%
  filter(STATE_ALPHA == "CA") %>% 
  filter(PRIM_LAT_DEC != 0, PRIM_LONG_DEC != 0)

gaz$FEATURE_NAME <- as.factor(gaz$FEATURE_NAME) # Type convert to a factor
gaz$FEATURE_CLASS <- as.factor(gaz$FEATURE_CLASS) # Type convert to a factor
#View(gaz)

```

5. Create a connect to the gaz.db and copy the tibble into the database.

```{r database, messsage = F, warning = F}

gaz.db <- DBI::dbConnect(RSQLite::SQLite(), path = ":memory:")

copy_to(gaz.db, gaz, "gaz", # What does the "::" mean?
  temporary = FALSE, 
  overwrite = TRUE,
  indexes = list(
    "FEATURE_ID", "FEATURE_NAME" 
  )
)

# Create a table cookie that connects to the database
gaz_db <- tbl(gaz.db, "gaz")
gaz_db

```

##Analyze the Data with SQL

1. What is the most frequently ocurring feature name?

```{r feature_name, message = F, warning = F}

count_names <- dbGetQuery(gaz.db, "SELECT FEATURE_NAME, COUNT() AS n_names FROM gaz
           GROUP BY FEATURE_NAME
           ORDER BY n_names DESC;")

count_names

```

The feature name that appears the most often is "Church of Christ".

2. What is the least-frequently-occuring feature class?

```{r feature_class, message = F, warning = F}

count_class <- dbGetQuery(gaz.db, "SELECT FEATURE_CLASS, COUNT() AS n_classes FROM gaz
                          GROUP BY FEATURE_CLASS
                          ORDER BY n_classes;")
count_class
```

The feature classes that appear the least are "Sea" and "Isthmus".

3. What is the approximate center point of each county?

Instead of finding the bounding box and calculating the center point, I chose to take the average latitude and longitude for each county. With such a large sample size for each county, this should be close to center point.

```{r center}

county_center <- dbGetQuery(gaz.db, "SELECT COUNTY_NAME AS 'County Name', AVG(PRIM_LAT_DEC) AS 'Center Latitude', AVG(PRIM_LONG_DEC) AS 'Center Longitude' FROM gaz GROUP BY COUNTY_NAME;")
county_center

```

4. What are the fractions of the total number of features in each county that are natural vs. man-made?

```{r fractions}

# Isolate the unique feature classes
classes <- gaz %>% 
  distinct(FEATURE_CLASS) %>% 
  arrange(FEATURE_CLASS)

# Create a new tibble that defines each class as natural or manmade
types <- mutate(classes,
                Class_Type = c("Manmade", "Natural", "Natural", "Natural", "Natural", "Natural", "Natural", "Natural", "Natural", "Natural", "Manmade", "Manmade", "Manmade", "Natural", "Manmade", "Manmade", "Natural", "Manmade", "Manmade", "Natural", "Natural", "Manmade", "Manmade", "Natural", "Natural", "Natural", "Natural", "Natural", "Natural", "Manmade", "Manmade", "Natural", "Natural", "Natural", "Natural", "Natural", "Manmade", "Manmade", "Manmade", "Manmade", "Manmade", "Natural", "Natural", "Manmade", "Manmade", "Natural", "Natural", "Manmade", "Manmade", "Natural", "Manmade", "Natural", "Natural", "Natural", "Natural", "Natural", "Natural", "Manmade", "Manmade", "Manmade", "Natural", "Manmade", "Natural")
)

# Import types into database
copy_to(gaz.db, types, "types",
  temporary = FALSE, 
  overwrite = TRUE
)

# Join types to gaz table and select desired columns
class_types <- dbGetQuery(gaz.db, "SELECT gaz.FEATURE_NAME, gaz.FEATURE_CLASS, gaz.COUNTY_NAME, types.Class_Type FROM gaz JOIN types ON gaz.FEATURE_CLASS = types.FEATURE_CLASS;")
head(class_types)

```






